"use strict";exports.id=495,exports.ids=[495],exports.modules={23495:(e,t,a)=>{a.d(t,{Z:()=>E});var r=a(10326),s=a(17577),l=a.n(s),n=a(60962),o=a(90434),i=a(97401),d=a(58080),c=a(94019),u=a(15515),m=a(77506),x=a(71709),h=a(19864),p=a(69436),b=a(59593),g=a(40617),f=a(9080),v=a(26394),j=a(16152),k=a(41135),N=a(33385);let w=e=>{try{let t;if(!e)return"刚刚";if("number"==typeof e)t=new Date(e<1e10?1e3*e:e);else{let a=Number(e);t=new Date(isNaN(a)||isNaN(parseFloat(e))?e:a<1e10?1e3*a:a)}if(isNaN(t.getTime())||2020>t.getFullYear())return"刚刚";return(0,i.Q)(t,{addSuffix:!0,locale:d.U}).replace("大约 ","")}catch(e){return"刚刚"}},y=e=>{let[t,a]=(0,s.useState)(!1),[l,o]=(0,s.useState)(!1);return(0,s.useEffect)(()=>{o(!0)},[]),(0,r.jsxs)(r.Fragment,{children:[r.jsx("img",{...e,className:"max-w-full h-auto max-h-[300px] rounded-lg border border-slate-200 dark:border-slate-700 cursor-zoom-in transition-transform hover:scale-[1.02] object-contain bg-slate-50 dark:bg-slate-900/50 my-2",onClick:e=>{e.stopPropagation(),a(!0)}}),t&&l&&(0,n.createPortal)(r.jsx("div",{className:"fixed inset-0 z-[9999] flex items-center justify-center bg-black/80 backdrop-blur-sm animate-in fade-in duration-200",onClick:e=>{e.stopPropagation(),a(!1)},children:(0,r.jsxs)("div",{className:"relative max-w-[90vw] max-h-[90vh]",children:[r.jsx("img",{src:e.src,alt:e.alt,className:"max-w-full max-h-[90vh] rounded-lg shadow-2xl animate-in zoom-in-95 duration-200 object-contain",onClick:e=>e.stopPropagation()}),r.jsx("button",{className:"absolute -top-12 right-0 p-2 text-white/70 hover:text-white bg-black/20 hover:bg-black/40 rounded-full transition-colors",onClick:e=>{e.stopPropagation(),a(!1)},children:r.jsx(c.Z,{size:24})})]})}),document.body)]})},D=({content:e})=>{let t=e.replace(/@([^ \t\n\r\f\v@,.!?;:，。！？]+)/g,(e,t)=>`[${e}](/player/${t})`);return r.jsx("span",{className:"prose dark:prose-invert prose-sm max-w-none text-slate-700 dark:text-slate-300 leading-relaxed break-words inline",children:r.jsx(f.UG,{remarkPlugins:[v.Z],components:{a:({node:e,...t})=>r.jsx(o.default,{href:t.href||"#",className:"text-emerald-500 hover:underline",onClick:e=>e.stopPropagation(),children:t.children}),p:({node:e,...t})=>r.jsx("span",{className:"inline",...t}),img:y},children:t})})},Z=["\uD83D\uDE00","\uD83D\uDE02","\uD83E\uDD23","\uD83D\uDE0D","\uD83E\uDD70","\uD83D\uDE0E","\uD83E\uDD14","\uD83D\uDE2D","\uD83D\uDC4D","\uD83D\uDC4E","\uD83C\uDF89","\uD83D\uDD25","❤️","\uD83D\uDC40","✨"],C=({onSubmit:e,placeholder:t="发表评论...",buttonText:a="发表评论",autoFocus:l=!1,onCancel:o})=>{let[i,d]=(0,s.useState)(""),[b,g]=(0,s.useState)(!1),[f,v]=(0,s.useState)(!1),[w,y]=(0,s.useState)(!1),[D,C]=(0,s.useState)([]),[S,E]=(0,s.useState)(!1),[z,$]=(0,s.useState)(!1);(0,s.useEffect)(()=>{$(!0)},[]);let R=(0,s.useRef)(null),T=(0,s.useRef)(null),F=(0,s.useRef)(null),[P,_]=(0,s.useState)({top:0,left:0}),U=()=>{if(F.current){let e=F.current.getBoundingClientRect();_({top:e.top+window.scrollY-310,left:e.left+window.scrollX})}};(0,s.useEffect)(()=>(w&&(U(),window.addEventListener("resize",U),window.addEventListener("scroll",U,!0)),()=>{window.removeEventListener("resize",U),window.removeEventListener("scroll",U,!0)}),[w]);let L=async t=>{if(t.preventDefault(),i.trim()||0!==D.length){g(!0);try{let t=i;D.length>0&&(t+="\n\n"+D.map(e=>`![](${e})`).join("\n")),await e(t),d(""),C([]),o&&o()}catch(e){console.error(e)}finally{g(!1)}}},M=(e,t=0)=>{let a=R.current;if(!a){d(t=>t+e);return}let r=a.selectionStart,s=a.selectionEnd;d(i.substring(0,r)+e+i.substring(s)),setTimeout(()=>{a.focus();let s=r+e.length+t;a.setSelectionRange(s,s)},0)},I=e=>{M(e),y(!1)},Y=()=>{T.current?.click()},A=async e=>{let t=e.target.files?.[0];if(t){if(!t.type.startsWith("image/")){alert("请选择图片文件");return}E(!0);try{let e=new FormData;e.append("file",t);let a=await (0,N.lY)(),r=await N.ZP.post("/api/upload/image",e,{headers:{"Content-Type":"multipart/form-data",...a}});C(e=>[...e,r.data.url])}catch(e){console.error(e),alert("图片上传失败")}finally{E(!1),T.current&&(T.current.value="")}}},B=e=>{C(t=>t.filter((t,a)=>a!==e))},G=()=>{M("@")},q=f||i.trim().length>0||D.length>0;return(0,r.jsxs)("form",{onSubmit:L,className:"relative group",children:[r.jsx("input",{type:"file",ref:T,onChange:A,accept:"image/*",className:"hidden"}),(0,r.jsxs)("div",{className:(0,k.Z)("relative rounded-2xl transition-all duration-300",f?"bg-white dark:bg-slate-900 border border-emerald-500/50 dark:border-emerald-500/50":"bg-slate-50 dark:bg-slate-900/30 hover:bg-white dark:hover:bg-slate-900 border border-slate-200 dark:border-slate-800"),children:[r.jsx(j.Z,{ref:R,value:i,onChange:e=>d(e.target.value),placeholder:t,autoFocus:l,onFocus:()=>v(!0),onBlur:()=>v(!1),className:(0,k.Z)("w-full bg-transparent border-none outline-none resize-none text-slate-900 dark:text-white text-base placeholder:text-slate-400/80 p-5 transition-all duration-300 ease-in-out","custom-scrollbar","min-h-[60px]")}),D.length>0&&r.jsx("div",{className:"px-5 pb-3 flex flex-wrap gap-2",children:D.map((e,t)=>(0,r.jsxs)("div",{className:"relative group/image",children:[r.jsx("img",{src:e,alt:"Uploaded preview",className:"w-20 h-20 object-cover rounded-lg border border-slate-200 dark:border-slate-700"}),r.jsx("button",{type:"button",onClick:()=>B(t),className:"absolute -top-2 -right-2 p-1 bg-red-500 text-white rounded-full opacity-0 group-hover/image:opacity-100 transition-opacity shadow-sm",children:r.jsx(c.Z,{size:12})})]},t))}),(0,r.jsxs)("div",{className:(0,k.Z)("flex items-center justify-between px-4 overflow-hidden transition-all duration-300 ease-in-out border-t",q?"max-h-[60px] py-3 opacity-100 border-slate-100 dark:border-slate-800/50":"max-h-0 py-0 opacity-0 border-transparent",f?"bg-slate-50/50 dark:bg-slate-900/50":"bg-transparent","rounded-b-2xl"),children:[(0,r.jsxs)("div",{className:"flex items-center gap-1 relative",children:[r.jsx("button",{ref:F,type:"button",onMouseDown:e=>{e.preventDefault(),y(!w)},className:(0,k.Z)("p-2 rounded-full transition-colors relative",w?"text-emerald-500 bg-emerald-50 dark:bg-emerald-500/10":"text-slate-400 hover:text-emerald-500 hover:bg-emerald-50 dark:hover:bg-emerald-500/10"),title:"表情",children:r.jsx(u.Z,{size:20})}),r.jsx("button",{type:"button",onMouseDown:e=>{e.preventDefault(),Y()},disabled:S,className:(0,k.Z)("p-2 rounded-full transition-colors",S?"text-emerald-500 bg-emerald-50 dark:bg-emerald-500/10 animate-pulse cursor-wait":"text-slate-400 hover:text-emerald-500 hover:bg-emerald-50 dark:hover:bg-emerald-500/10"),title:"图片",children:S?r.jsx(m.Z,{size:20,className:"animate-spin"}):r.jsx(x.Z,{size:20})}),r.jsx("button",{type:"button",onMouseDown:e=>{e.preventDefault(),G()},className:"p-2 text-slate-400 hover:text-emerald-500 hover:bg-emerald-50 dark:hover:bg-emerald-500/10 rounded-full transition-colors",title:"提及",children:r.jsx(h.Z,{size:20})})]}),(0,r.jsxs)("div",{className:"flex items-center gap-3",children:[o&&r.jsx("button",{type:"button",onClick:o,className:"text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200 text-sm font-medium px-3 py-1.5 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors",children:"取消"}),(0,r.jsxs)("button",{type:"submit",disabled:b||!i.trim()&&0===D.length,className:(0,k.Z)("flex items-center gap-2 px-5 py-2 rounded-xl text-sm font-bold text-white transition-all duration-300 shadow-md",i.trim()||D.length>0?"bg-gradient-to-r from-emerald-500 to-teal-500 hover:from-emerald-600 hover:to-teal-600 hover:shadow-lg hover:shadow-emerald-500/20 active:scale-95 translate-y-0":"bg-slate-300 dark:bg-slate-700 text-slate-100 cursor-not-allowed shadow-none"),children:[b?r.jsx(m.Z,{size:18,className:"animate-spin"}):r.jsx(p.Z,{size:18}),r.jsx("span",{children:b?"发送中...":a})]})]})]}),w&&z&&(0,n.createPortal)((0,r.jsxs)(r.Fragment,{children:[r.jsx("div",{className:"fixed inset-0 z-[9998]",onClick:()=>y(!1)}),r.jsx("div",{className:"fixed z-[9999] p-3 bg-white dark:bg-slate-800 rounded-xl shadow-xl border border-slate-200 dark:border-slate-700 grid grid-cols-6 gap-2 w-72 animate-in fade-in zoom-in-95 duration-200",style:{top:P.top,left:P.left},children:Z.map(e=>r.jsx("button",{type:"button",onMouseDown:e=>e.preventDefault(),onClick:()=>I(e),className:"p-2 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg text-xl transition-colors flex items-center justify-center",children:e},e))})]}),document.body)]})]})},S=({comment:e,currentUser:t,onReply:a,replyingToId:s,onSubmitReply:l,onDelete:n,onLike:i,depth:d=0})=>{let c=t&&(t.username===e.author.username||"admin"===t.role),u=s===e.id,m=r.jsx("div",{className:(0,k.Z)("grid transition-[grid-template-rows] duration-300 ease-in-out",u?"grid-rows-[1fr]":"grid-rows-[0fr]"),children:r.jsx("div",{className:"overflow-hidden",children:r.jsx("div",{className:(0,k.Z)("transition-all duration-300 transform origin-top",u?"opacity-100 translate-y-0 pt-4 pb-2":"opacity-0 -translate-y-4 pt-0 pb-0"),children:(0,r.jsxs)("div",{className:"flex gap-3",children:[r.jsx("img",{src:t?.avatar||`https://cravatar.eu/helmavatar/${t?.username}/64.png`,alt:"Current User",className:"w-8 h-8 rounded-lg bg-slate-100 object-cover hidden sm:block border border-slate-200 dark:border-slate-700"}),r.jsx("div",{className:"flex-1",children:r.jsx(C,{onSubmit:l,placeholder:`回复 @${e.author.nickname||e.author.username}...`,buttonText:"回复",autoFocus:u,onCancel:()=>a(null)})})]})})})});return 0===d?(0,r.jsxs)("div",{className:"flex gap-4 group",children:[r.jsx(o.default,{href:`/player/${e.author.username}`,className:"flex-shrink-0",children:r.jsx("img",{src:e.author.avatar||`https://cravatar.eu/helmavatar/${e.author.username}/64.png`,alt:e.author.username,className:"w-10 h-10 rounded-xl bg-slate-100 object-cover border border-slate-200 dark:border-slate-700 transition-all hover:scale-105"})}),(0,r.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,r.jsxs)("div",{className:"flex items-center gap-2 mb-1",children:[r.jsx(o.default,{href:`/player/${e.author.username}`,className:"font-bold text-slate-900 dark:text-white hover:text-emerald-500 transition-colors text-sm",children:e.author.nickname||e.author.username}),e.author.custom_title&&"玩家"!==e.author.custom_title&&r.jsx("span",{className:"px-1.5 py-0.5 rounded text-[10px] font-medium bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 border border-blue-100 dark:border-blue-800/50",children:e.author.custom_title})]}),r.jsx("div",{className:"mb-2",children:r.jsx("div",{className:"prose dark:prose-invert prose-sm max-w-none text-slate-700 dark:text-slate-300 leading-relaxed break-words",children:r.jsx(f.UG,{remarkPlugins:[v.Z],components:{a:({node:e,...t})=>r.jsx(o.default,{href:t.href||"#",className:"text-emerald-500 hover:underline",onClick:e=>e.stopPropagation(),children:t.children}),p:({node:e,...t})=>r.jsx("p",{className:"mb-1 last:mb-0",...t}),img:y},children:e.content.replace(/@([^ \t\n\r\f\v@,.!?;:，。！？]+)/g,(e,t)=>`[${e}](/player/${t})`)})})}),(0,r.jsxs)("div",{className:"flex items-center gap-4 text-xs text-slate-400 mb-3",children:[r.jsx("span",{children:w(e.created_at)}),i&&(0,r.jsxs)("button",{onClick:()=>i(e.id),className:"flex items-center gap-1 hover:text-emerald-500 transition-colors",children:[r.jsx(b.Z,{size:12}),r.jsx("span",{children:e.likes_count||0})]}),r.jsx("button",{onClick:()=>a(u?null:e),className:(0,k.Z)("transition-all duration-200 px-2 py-0.5 rounded-md -ml-2",u?"bg-emerald-50 text-emerald-600 dark:bg-emerald-500/10 dark:text-emerald-400":"hover:bg-slate-100 dark:hover:bg-slate-800 hover:text-emerald-500"),children:u?"取消回复":"回复"}),c&&n&&r.jsx("button",{onClick:()=>n(e.id),className:"hover:text-red-500 transition-colors opacity-0 group-hover:opacity-100",children:"删除"})]}),m,e.replies&&e.replies.length>0&&r.jsx("div",{className:"space-y-3",children:e.replies.map(e=>r.jsx(S,{comment:e,currentUser:t,onReply:a,replyingToId:s,onSubmitReply:l,onDelete:n,onLike:i,depth:d+1},e.id))})]})]}):(0,r.jsxs)("div",{className:"flex gap-2 group",children:[r.jsx(o.default,{href:`/player/${e.author.username}`,className:"flex-shrink-0 mt-0.5",children:r.jsx("img",{src:e.author.avatar||`https://cravatar.eu/helmavatar/${e.author.username}/64.png`,alt:e.author.username,className:"w-6 h-6 rounded-lg bg-slate-100 object-cover border border-slate-200 dark:border-slate-700 transition-all hover:scale-105"})}),(0,r.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,r.jsxs)("div",{className:"flex flex-wrap items-baseline gap-x-2",children:[r.jsx(o.default,{href:`/player/${e.author.username}`,className:"font-bold text-xs text-slate-700 dark:text-slate-200 hover:text-emerald-500 transition-colors",children:e.author.nickname||e.author.username}),e.author.custom_title&&"玩家"!==e.author.custom_title&&r.jsx("span",{className:"px-1 py-0 rounded text-[10px] font-medium bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 border border-blue-100 dark:border-blue-800/50 scale-90 origin-left",children:e.author.custom_title}),r.jsx("span",{className:"text-sm text-slate-800 dark:text-slate-300 break-words",children:r.jsx("span",{className:"inline-block",children:r.jsx(D,{content:e.content})})})]}),(0,r.jsxs)("div",{className:"flex items-center gap-4 text-xs text-slate-400 mt-1",children:[r.jsx("span",{children:w(e.created_at)}),i&&(0,r.jsxs)("button",{onClick:()=>i(e.id),className:"flex items-center gap-1 hover:text-emerald-500 transition-colors",children:[r.jsx(b.Z,{size:11}),r.jsx("span",{children:e.likes_count||0})]}),r.jsx("button",{onClick:()=>a(u?null:e),className:(0,k.Z)("transition-all duration-200 px-2 py-0.5 rounded-md -ml-2",u?"bg-emerald-50 text-emerald-600 dark:bg-emerald-500/10 dark:text-emerald-400":"hover:bg-slate-100 dark:hover:bg-slate-800 hover:text-emerald-500"),children:u?"取消回复":"回复"}),c&&n&&r.jsx("button",{onClick:()=>n(e.id),className:"hover:text-red-500 transition-colors opacity-0 group-hover:opacity-100",children:"删除"})]}),m,e.replies&&e.replies.length>0&&r.jsx("div",{className:"mt-2 space-y-2",children:e.replies.map(e=>r.jsx(S,{comment:e,currentUser:t,onReply:a,replyingToId:s,onSubmitReply:l,onDelete:n,onLike:i,depth:d+1},e.id))})]})]})},E=({comments:e,currentUser:t,onSubmit:a,onDelete:n,onLike:i,loading:d=!1,title:c="评论",className:u,hideMainInput:x=!1})=>{let[h,p]=(0,s.useState)(null),b=async e=>{h&&(await a(e,h.id),p(null))},f=async e=>{await a(e)};return(0,r.jsxs)("div",{className:(0,k.Z)("bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 p-6 sm:p-8",u),children:[(0,r.jsxs)("h3",{className:"text-lg font-bold text-slate-900 dark:text-white mb-6 flex items-center gap-2",children:[r.jsx(g.Z,{className:"text-emerald-500",size:20}),c," ",(0,r.jsxs)("span",{className:"text-slate-400 font-normal text-sm ml-1",children:["(",e.reduce((e,t)=>e+1+(t.replies?.length||0),0),")"]})]}),!x&&(t?(0,r.jsxs)("div",{className:"flex gap-4 mb-8",children:[r.jsx("img",{src:t.avatar||`https://cravatar.eu/helmavatar/${t.username}/64.png`,alt:t.username,className:"w-10 h-10 rounded-xl bg-slate-100 border border-slate-200 dark:border-slate-700 flex-shrink-0"}),r.jsx("div",{className:"flex-1",children:r.jsx(C,{onSubmit:f})})]}):(0,r.jsxs)("div",{className:"text-center py-6 bg-slate-50 dark:bg-slate-900/50 rounded-xl border border-dashed border-slate-300 dark:border-slate-700 mb-8",children:[r.jsx("p",{className:"text-slate-500 mb-2 text-sm",children:"登录后参与讨论"}),r.jsx(o.default,{href:"/login",className:"text-emerald-500 font-medium hover:underline text-sm",children:"立即登录"})]})),r.jsx("div",{children:d?r.jsx("div",{className:"flex justify-center py-12",children:r.jsx(m.Z,{className:"w-8 h-8 animate-spin text-emerald-500"})}):0===e.length?r.jsx("div",{className:"text-center py-12 text-slate-500 text-sm",children:"暂无评论，快来抢沙发吧！"}):e.map((e,a)=>(0,r.jsxs)(l().Fragment,{children:[a>0&&r.jsx("div",{className:"h-px bg-slate-200 dark:bg-slate-700 my-4"}),r.jsx(S,{comment:e,currentUser:t,onReply:p,replyingToId:h?.id||null,onSubmitReply:b,onDelete:n,onLike:i})]},e.id))})]})}},16152:(e,t,a)=>{a.d(t,{Z:()=>i});var r=a(10326),s=a(17577),l=a.n(s),n=a(33385),o=a(77506);let i=l().forwardRef(({value:e,onChange:t,className:a,containerClassName:l,...i},d)=>{let[c,u]=(0,s.useState)([]),[m,x]=(0,s.useState)(!1),[h,p]=(0,s.useState)(0),[b,g]=(0,s.useState)(!1),[f,v]=(0,s.useState)(""),[j,k]=(0,s.useState)(-1),N=(0,s.useRef)(null),w=(0,s.useRef)(null);(0,s.useEffect)(()=>{d&&("function"==typeof d?d(N.current):d.current=N.current)},[d]),(0,s.useEffect)(()=>{if(i.autoFocus&&N.current){let e=setTimeout(()=>{N.current?.focus()},50);return()=>clearTimeout(e)}},[i.autoFocus]),(0,s.useEffect)(()=>{if(!m)return;let e=setTimeout(async()=>{g(!0);try{let e=await n.ZP.get(`/api/profile/search?q=${f}`);u(e.data),p(0)}catch(e){console.error("Failed to search users",e)}finally{g(!1)}},300);return()=>clearTimeout(e)},[f,m]);let y=a=>{if(-1===j)return;let r=e.substring(0,j),s=e.substring(j+1+f.length),l=`${r}@${a.username} ${s}`;t({target:{value:l},currentTarget:{value:l}}),x(!1),setTimeout(()=>{if(N.current){N.current.focus();let e=j+1+a.username.length+1;N.current.setSelectionRange(e,e)}},0)};return(0,r.jsxs)("div",{className:`relative ${l||""}`,children:[r.jsx("textarea",{ref:N,value:e,onChange:e=>{t(e);let a=e.target.value,r=e.target.selectionStart,s=!1;for(let e=r-1;e>=0;e--){let t=a[e];if("@"===t){if(0===e||/\s/.test(a[e-1])){let t=a.substring(e+1,r);/\s/.test(t)||(k(e),v(t),x(!0),s=!0)}break}if(/\s/.test(t))break}s||x(!1)},onKeyDown:e=>{m&&c.length>0&&("ArrowDown"===e.key?(e.preventDefault(),p(e=>(e+1)%c.length)):"ArrowUp"===e.key?(e.preventDefault(),p(e=>(e-1+c.length)%c.length)):"Enter"===e.key||"Tab"===e.key?(e.preventDefault(),y(c[h])):"Escape"===e.key&&x(!1))},className:a,...i}),m&&r.jsx("div",{ref:w,className:"absolute z-50 w-64 bg-white dark:bg-slate-800 rounded-lg shadow-xl border border-slate-200 dark:border-slate-700 overflow-hidden mt-1 left-0",style:{top:"100%"},children:b?(0,r.jsxs)("div",{className:"p-2 flex items-center justify-center text-slate-500",children:[r.jsx(o.Z,{size:16,className:"animate-spin mr-2"})," 搜索中..."]}):c.length>0?r.jsx("ul",{className:"max-h-48 overflow-y-auto",children:c.map((e,t)=>(0,r.jsxs)("li",{onClick:()=>y(e),className:`flex items-center px-3 py-2 cursor-pointer transition-colors ${t===h?"bg-emerald-50 dark:bg-emerald-900/20 text-emerald-600 dark:text-emerald-400":"hover:bg-slate-50 dark:hover:bg-slate-700/50 text-slate-700 dark:text-slate-200"}`,children:[r.jsx("img",{src:e.avatar||`https://cravatar.eu/helmavatar/${e.username}/16.png`,alt:e.username,className:"w-6 h-6 rounded-full mr-2"}),r.jsx("span",{className:"text-sm",children:e.username})]},e.username))}):r.jsx("div",{className:"p-2 text-center text-slate-500 text-xs",children:"没有找到用户"})})]})})}};